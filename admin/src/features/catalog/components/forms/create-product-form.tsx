'use client'
import React, { useEffect, useRef } from 'react'
import {
  useForm,
  Controller,
  FormProvider,
  useFormContext,
} from 'react-hook-form'
import { z } from 'zod'
import { zodResolver } from '@hookform/resolvers/zod'
import { Breadcrumbs, Button, Stack } from '@mui/material'
import Box from '@mui/material/Box'
import Typography from '@avc/components/ui/typography'
import FormLabel from '@avc/components/ui/label'
import TextField from '@avc/components/ui/text-field'
import Switch from '@avc/components/ui/switch'
import Card, { CardContent, CardActions } from '@avc/components/ui/card'
import {
  MenuButtonBold,
  MenuButtonItalic,
  MenuControlsContainer,
  MenuDivider,
  MenuSelectHeading,
  RichTextEditor,
  type RichTextEditorRef,
} from 'mui-tiptap'
import StarterKit from '@tiptap/starter-kit'
import AssetPickerDialog from '@avc/features/assets/components/asset-picker-dialog'
import { useMutation } from '@avc/lib/hooks/use-mutation'
import { CREATE_PRODUCT } from '@avc/graphql/mutations'
import { useSnackbar } from '@avc/context/snackbar-context'
import FacetValuePickerDialog from '../pickers/facet-value-picker-dialog'
import FormLayout from '@avc/components/layout/form-layout'
import { CreateProductInput, Facet } from '@avc/generated/graphql'
import Link from 'next/link'
import { SeoMetadataForm } from '@avc/features/seo/components/seo-metadata-form'
import FormTabs from '@avc/components/common/form-tabs'
import FormHeader from '@avc/components/common/typography/form-header'
import { seoMetadataSchema } from '@avc/features/seo/schema/seo-metadata.schema'
import { seoMetadataEmpty } from '@avc/features/seo/data/seo-metadata-empty'
import { useRouter } from 'next/navigation'

const createProductSchema = z.object({
  autoGenerated: z.boolean().optional(),
  description: z.string().min(1, 'Açıklama zorunludur'),
  isPrivate: z.boolean().optional(),
  facetValueIds: z.array(z.string()).optional(),
  name: z.string().min(1, 'Ürün adı zorunludur'),
  slug: z.string().min(1, 'Slug zorunludur'),
  assets: z.array(z.any()).optional(),

  seoMetadata: seoMetadataSchema,
})

type CreateProductInputForm = z.infer<typeof createProductSchema>

export default function CreateProductForm({ facets }: { facets: Facet[] }) {
  const router = useRouter()
  const { snackbar } = useSnackbar()
  const [createProductMutation, { loading: createProductLoading }] =
    useMutation(CREATE_PRODUCT)

  const rteRef = useRef<RichTextEditorRef>(null)
  const formMethods = useForm<Zod.infer<typeof createProductSchema>>({
    resolver: zodResolver(createProductSchema),
    defaultValues: {
      autoGenerated: false,
      isPrivate: false,
      description: '',
      name: '',
      slug: '',
      facetValueIds: [],
      assets: [],
      seoMetadata: seoMetadataEmpty,
    },
  })

  const { control, handleSubmit, watch } = formMethods

  const values = watch()

  const createProduct = async (data: CreateProductInputForm) => {
    const normalizedData = normalizeProductForm(data)
    const result = await createProductMutation({
      variables: { input: normalizedData },
    })
    return result.data?.createProduct
  }

  const onSubmit = async (data: CreateProductInputForm) => {
    const newProduct = await createProduct(data)

    if (newProduct) {
      snackbar({
        message: 'Ürün başarıyla oluşturuldu',
        variant: 'default',
      })
      router.push(`/katalog/urunler/${newProduct.id}`)
    } else {
      snackbar({
        message: 'Ürün oluşturulurken bir hata oluştu',
        variant: 'error',
      })
    }
  }

  const detailsForm = (
    <Stack direction="column" spacing={2} sx={{ px: 4 }}>
      <FormHeader
        title="Ürün Detayları"
        tooltip="Ürünün detaylarını buradan düzenleyebilirsiniz"
      />
      <Box sx={{ display: 'flex', gap: 2 }}>
        <Controller
          name="name"
          control={control}
          render={({ field, fieldState: { error } }) => (
            <TextField
              {...field}
              error={!!error}
              helperText={error?.message}
              placeholder="Ürün adı buraya..."
              fullWidth
            />
          )}
        />
        <Controller
          name="slug"
          control={control}
          render={({ field, fieldState: { error } }) => (
            <TextField
              {...field}
              error={!!error}
              helperText={error?.message}
              placeholder="Slug"
              fullWidth
            />
          )}
        />
      </Box>

      <Box>
        <FormLabel sx={{ display: 'block' }}>Ürün Açıklaması</FormLabel>
        <Typography variant="caption" color="textSecondary">
          Bu ürün için kısa bir açıklama yazın
        </Typography>
        <Controller
          name="description"
          control={control}
          render={({ field }) => (
            <RichTextEditor
              ref={rteRef}
              extensions={[StarterKit]}
              content={field.value}
              onUpdate={({ editor }) => {
                field.onChange(editor.getHTML())
              }}
              renderControls={() => (
                <MenuControlsContainer>
                  <MenuSelectHeading />
                  <MenuDivider />
                  <MenuButtonBold />
                  <MenuButtonItalic />
                </MenuControlsContainer>
              )}
              editorProps={{
                attributes: {
                  style: 'height: 200px; overflow-y: auto;',
                },
              }}
            />
          )}
        />
      </Box>
      <Box>
        <Controller
          name="assets"
          control={control}
          render={({ field }) => (
            <AssetPickerDialog
              selectedAssets={field.value || []}
              onAssetsChange={field.onChange}
            />
          )}
        />
      </Box>
    </Stack>
  )

  const seoMetadataForm = <SeoMetadataForm isProduct />

  const rightContent = (
    <PublishCard loading={createProductLoading} facets={facets} />
  )

  const header = (
    <Box
      sx={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
      }}
    >
      <Typography sx={{ px: 4 }} variant="h5" fontWeight="bold">
        Ürün Oluştur
      </Typography>
      <Breadcrumbs sx={{ px: 4 }}>
        <Typography color="text.primary">Katalog</Typography>
        <Link href="/katalog/urunler">
          <Typography color="text.primary">Ürünler</Typography>
        </Link>
        <Typography color="textDisabled">Yeni Ürün Oluştur</Typography>
      </Breadcrumbs>
    </Box>
  )

  const tabs = [
    { label: 'Ürün Detayları', node: detailsForm },
    { label: 'SEO', node: seoMetadataForm },
  ]

  return (
    <FormProvider {...formMethods}>
      <form onSubmit={handleSubmit(onSubmit)}>
        <FormLayout
          title={header}
          leftContent={<FormTabs tabs={tabs} />}
          rightContent={rightContent}
        />
      </form>
    </FormProvider>
  )
}

function PublishCard({
  loading,
  facets,
}: {
  loading: boolean
  facets: Facet[]
}) {
  const {
    control,
    formState: { isDirty },
    watch,
  } = useFormContext<CreateProductInputForm>()

  const isPrivate = watch('isPrivate')
  const facetValueIds = watch('facetValueIds')

  return (
    <Card sx={{ p: 0 }}>
      <CardContent sx={{ p: 0 }}>
        <Box
          sx={{
            display: 'flex',
            justifyContent: 'space-between',
            borderBottom: '1px solid',
            borderColor: 'divider',
            p: 2,
          }}
        >
          <Box>
            <Typography variant="h6">Yayınla</Typography>
            <Typography variant="body2">Ürünü şimdi yayınlayın</Typography>
          </Box>
          <Box>
            <Controller
              name="isPrivate"
              control={control}
              render={({ field }) => (
                <Switch
                  {...field}
                  checked={field.value || false}
                  onChange={(e) => field.onChange(e.target.checked)}
                />
              )}
            />
          </Box>
        </Box>
        <Box sx={{ px: 2, pt: 2 }}>
          <Controller
            name="facetValueIds"
            control={control}
            render={({ field }) => (
              <FacetValuePickerDialog
                facets={facets}
                selectedFacetValues={field.value || []}
                onSelectionChange={(selected) =>
                  field.onChange(selected as string[])
                }
              />
            )}
          />
        </Box>
      </CardContent>
      <CardActions
        sx={{
          p: 2,
        }}
      >
        <Button
          disabled={!isDirty || loading}
          variant="contained"
          size="large"
          fullWidth
          type="submit"
        >
          <Typography
            variant="button"
            sx={{ textTransform: 'none' }}
            fontWeight="bold"
          >
            {loading
              ? 'Oluşturuluyor...'
              : isPrivate
              ? 'Kaydet'
              : 'Şimdi yayınla'}
          </Typography>
        </Button>
      </CardActions>
    </Card>
  )
}

function normalizeProductForm(
  product: Zod.infer<typeof createProductSchema>
): CreateProductInput {
  return {
    name: product.name,
    slug: product.slug,
    description: product.description,
    isPrivate: product.isPrivate,
    facetValueIds: product.facetValueIds,
    featuredAssetId: product.assets?.find((a) => a.featured)?.id,
    documentIds: product.assets
      ?.filter((a) => a.type === 'DOCUMENT')
      ?.map((d) => d.id),
    seoMetadata: product.seoMetadata as any,
  }
}
